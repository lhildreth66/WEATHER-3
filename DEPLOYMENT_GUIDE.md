# RouteCast Production Deployment Guide

## Pre-Deployment Checklist

Before starting, ensure you have:
- [ ] Render.com account
- [ ] MongoDB Atlas account (or existing cluster)
- [ ] Stripe account with API keys
- [ ] SendGrid account with API key
- [ ] Domain DNS access for `routecastweather.com`

---

## Step 1: Connect Repository to Render

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click **"New +"** → **"Blueprint"**
3. Connect your GitHub/GitLab repository containing this code
4. Render will auto-detect the `render.yaml` file

> **Note:** The `render.yaml` defines two services:
> - `routecast-api` (Backend - Python)
> - `routecast-app` (Frontend - Static)

---

## Step 2: Configure Environment Variables

After Render creates the services, you need to set the **secret environment variables**.

### For `routecast-api` (Backend):

Navigate to: **Dashboard → routecast-api → Environment**

Set these values (marked as `sync: false` in render.yaml):

| Variable | Value | Notes |
|----------|-------|-------|
| `MONGO_URL` | `mongodb+srv://user:pass@cluster.mongodb.net/routecast` | Your MongoDB Atlas connection string |
| `MAPBOX_ACCESS_TOKEN` | `pk.eyJ1...` | Your Mapbox public token |
| `GOOGLE_API_KEY` | `AIza...` | Your Google API key |
| `SENDGRID_API_KEY` | `SG.xxx...` | Your SendGrid API key |
| `STRIPE_API_KEY` | `sk_live_...` or `sk_test_...` | Your Stripe secret key |
| `STRIPE_WEBHOOK_SECRET` | `whsec_...` | From Stripe webhook setup (Step 4) |

> **Auto-generated:** `JWT_SECRET_KEY` and `ADMIN_API_KEY` are auto-generated by Render.
> Save the `ADMIN_API_KEY` value - you'll need it for admin operations.

---

## Step 3: Configure Custom Domains

### Backend API (`api.routecastweather.com`):

1. Go to **Dashboard → routecast-api → Settings → Custom Domains**
2. Click **"Add Custom Domain"**
3. Enter: `api.routecastweather.com`
4. Add DNS record at your registrar:
   - **Type:** CNAME
   - **Name:** `api`
   - **Value:** `routecast-api.onrender.com` (Render provides this)
5. Wait for SSL certificate to issue (usually < 5 minutes)

### Frontend App (`app.routecastweather.com`):

1. Go to **Dashboard → routecast-app → Settings → Custom Domains**
2. Click **"Add Custom Domain"**
3. Enter: `app.routecastweather.com`
4. Add DNS record:
   - **Type:** CNAME
   - **Name:** `app`
   - **Value:** `routecast-app.onrender.com`
5. Wait for SSL certificate

---

## Step 4: Configure Stripe Webhooks

1. Go to [Stripe Dashboard → Webhooks](https://dashboard.stripe.com/webhooks)
2. Click **"Add endpoint"**
3. Enter endpoint URL: `https://api.routecastweather.com/api/webhooks/stripe`
4. Select events to listen for:
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.paid`
   - `invoice.payment_failed`
5. Click **"Add endpoint"**
6. Copy the **Signing secret** (`whsec_...`)
7. Add it to Render as `STRIPE_WEBHOOK_SECRET`

---

## Step 5: Deploy and Verify

### Trigger Deployment:
Render auto-deploys on git push. To manually deploy:
1. Go to service → **"Manual Deploy"** → **"Deploy latest commit"**

### Verify Endpoints:

```bash
# Health check
curl https://api.routecastweather.com/health
# Expected: {"status":"healthy","service":"routecast-api"}

# API health
curl https://api.routecastweather.com/api/health
# Expected: {"status":"healthy","timestamp":"..."}

# Auth signup test
curl -X POST https://api.routecastweather.com/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"SecurePass123!"}'
# Expected: {"success":true,"message":"..."}

# Subscription plans
curl https://api.routecastweather.com/api/subscriptions/plans
# Expected: [{"id":"monthly","name":"Monthly",...},...]
```

### Verify Frontend:
1. Open `https://app.routecastweather.com`
2. Verify the app loads correctly
3. Check browser console for API connection errors

---

## Step 6: Post-Deployment Configuration

### Save Admin API Key:
1. Go to **routecast-api → Environment**
2. Copy the auto-generated `ADMIN_API_KEY` value
3. Store it securely - needed for admin operations

### Test Admin Endpoints:
```bash
# List users (replace YOUR_ADMIN_KEY)
curl -H "X-Admin-Key: YOUR_ADMIN_KEY" \
  https://api.routecastweather.com/api/admin/users
```

### Configure SendGrid:
1. Verify sender email `noreply@routecastweather.com` in SendGrid
2. Or update `SENDER_EMAIL` to a verified sender address

---

## Troubleshooting

### Backend won't start:
- Check Render logs: **Dashboard → routecast-api → Logs**
- Verify `MONGO_URL` is correct and accessible
- Ensure all required env vars are set

### SSL certificate pending:
- DNS propagation takes up to 24 hours
- Verify CNAME records with: `dig api.routecastweather.com CNAME`

### Stripe webhooks failing:
- Verify webhook URL is exactly: `https://api.routecastweather.com/api/webhooks/stripe`
- Check `STRIPE_WEBHOOK_SECRET` matches the signing secret from Stripe dashboard
- Check Stripe webhook logs for error details

### Frontend not loading:
- Verify `EXPO_PUBLIC_BACKEND_URL` is set to `https://api.routecastweather.com`
- Check browser network tab for CORS errors
- Clear browser cache and retry

---

## Service URLs Summary

| Service | Production URL | Fallback (Render default) |
|---------|---------------|---------------------------|
| Backend API | `https://api.routecastweather.com` | `https://routecast-api.onrender.com` |
| Frontend App | `https://app.routecastweather.com` | `https://routecast-app.onrender.com` |

---

## Next Steps After Deployment

1. **Complete frontend auth UI** (signup, login, subscription pages)
2. **Test subscription flow** with Stripe test cards
3. **Configure email templates** in SendGrid
4. **Set up monitoring** (Render provides basic metrics)
5. **Configure Stripe production mode** when ready to go live

---

## Quick Reference - API Endpoints

### Public Endpoints:
- `GET /health` - Service health check
- `GET /api/health` - API health check
- `POST /api/auth/signup` - User registration
- `POST /api/auth/login` - User login
- `POST /api/auth/refresh` - Refresh access token
- `GET /api/subscriptions/plans` - Get subscription plans

### Protected Endpoints (require Bearer token):
- `GET /api/me` - Get current user profile
- `POST /api/subscriptions/start-trial` - Start free trial
- `POST /api/subscriptions/create-checkout-session` - Create Stripe checkout

### Webhook Endpoints:
- `POST /api/webhooks/stripe` - Stripe payment webhooks

### Admin Endpoints (require X-Admin-Key header):
- `GET /api/admin/users` - List all users
- `POST /api/admin/users/{user_id}/grant-premium` - Grant premium access
